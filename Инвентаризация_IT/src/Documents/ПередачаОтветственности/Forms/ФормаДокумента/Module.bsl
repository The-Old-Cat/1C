
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	// Получаем переданное значение из параметров формы
    Если Параметры.Свойство("УвольняемыйСотрудник") Тогда
        УвольняемыйСотрудник = Параметры.УвольняемыйСотрудник;
    КонецЕсли;
    Объект.УвольняемыйСотрудник = УвольняемыйСотрудник;
КонецПроцедуры

&НаКлиенте
Процедура УвольняемыйСотрудникПриИзменении(Элемент)
	    // Получаем увольняемого сотрудника
    УвольняемыйСотрудник = Объект.УвольняемыйСотрудник;
	
	// Проверяем, выбран ли сотрудник
    Если УвольняемыйСотрудник <> Неопределено Тогда
        // Получаем подразделение сотрудника
        Подразделение = ПолучитьПодразделениеСотрудника(УвольняемыйСотрудник);

        // Заполняем реквизит "Подразделение" на форме
        Объект.Подразделение = Подразделение;
    Иначе
        // Очищаем реквизит "Подразделение", если сотрудник не выбран
        Объект.Подразделение = Неопределено;
    КонецЕсли;
	
    // Получаем список рабочих мест увольняемого сотрудника
    СписокРабочихМест = ПолучитьСписокРабочихМестСотрудника(УвольняемыйСотрудник);

    // Заполняем табличную часть "РабочиеМеста"
    ЗаполнитьТабличнуюЧастьРабочиеМеста(СписокРабочихМест);
КонецПроцедуры

&НаСервере
Функция ПолучитьСписокРабочихМестСотрудника(Сотрудник)

    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    РабочиеМеста.Ссылка
    |ИЗ
    |    Документ.РабочиеМеста КАК РабочиеМеста
    |ГДЕ
    |    РабочиеМеста.Ответственный = &Сотрудник";

    Запрос.УстановитьПараметр("Сотрудник", Сотрудник);
    РезультатЗапроса = Запрос.Выполнить();

    СписокРабочихМест = Новый Массив;
    Если Не РезультатЗапроса.Пустой() Тогда
        Выборка = РезультатЗапроса.Выбрать();
        Пока Выборка.Следующий() Цикл
            СписокРабочихМест.Добавить(Выборка.Ссылка);
        КонецЦикла;
    КонецЕсли;

    Возврат СписокРабочихМест;

КонецФункции

&НаКлиенте
Процедура ЗаполнитьТабличнуюЧастьРабочиеМеста(СписокРабочихМест)

    ТЧРабочиеМеста = Объект.РабочиеМеста;

    Для Каждого РабочееМесто Из СписокРабочихМест Цикл
        НоваяСтрока = ТЧРабочиеМеста.Добавить();
        НоваяСтрока.РабочееМесто = РабочееМесто;

        // Получаем подразделение из документа "РабочиеМеста"
        //@skip-check query-in-loop
        Подразделение = ПолучитьПодразделениеИзДокументаРабочиеМеста(РабочееМесто);
        НоваяСтрока.Подразделение = Подразделение;
    КонецЦикла;

КонецПроцедуры

&НаСервере
Функция ПолучитьПодразделениеИзДокументаРабочиеМеста(РабочееМесто)

    // Получаем подразделение из документа "РабочиеМеста"
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    РабочиеМеста.Подразделение
    |ИЗ
    |    Документ.РабочиеМеста КАК РабочиеМеста
    |ГДЕ
    |    РабочиеМеста.Ссылка = &РабочееМесто";

    Запрос.УстановитьПараметр("РабочееМесто", РабочееМесто);
    РезультатЗапроса = Запрос.Выполнить();

    Если Не РезультатЗапроса.Пустой() Тогда
        Выборка = РезультатЗапроса.Выбрать();
        Если Выборка.Следующий() Тогда
            Возврат Выборка.Подразделение;
        КонецЕсли;
    КонецЕсли;

    Возврат Неопределено;

КонецФункции    


&НаСервере
Функция ПолучитьПодразделениеСотрудника(Сотрудник)

    // Проверяем, передан ли сотрудник
    Если Сотрудник = Неопределено Тогда
        Возврат Неопределено;
    КонецЕсли;

    // Получаем подразделение сотрудника
    Возврат Сотрудник.Подразделение;

КонецФункции